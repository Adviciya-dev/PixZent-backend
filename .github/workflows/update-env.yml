name: Update Lambda Environment Variables

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'Deployment stage'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod
      mongo_url:
        description: 'New MongoDB URL'
        required: true
        type: string

env:
  AWS_REGION: us-east-1

jobs:
  update-env:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update Lambda Environment Variables
        run: |
          FUNCTION_NAME="pixzent-api-${{ github.event.inputs.stage }}"

          echo "Updating MONGO_URL for ${FUNCTION_NAME}..."

          # Get current environment variables
          CURRENT_ENV=$(aws lambda get-function-configuration \
            --function-name ${FUNCTION_NAME} \
            --query 'Environment.Variables' \
            --output json)

          # Update MONGO_URL while preserving other variables
          UPDATED_ENV=$(echo $CURRENT_ENV | jq --arg url "${{ github.event.inputs.mongo_url }}" '. + {MONGO_URL: $url}')

          # Apply the update
          aws lambda update-function-configuration \
            --function-name ${FUNCTION_NAME} \
            --environment "Variables=${UPDATED_ENV}"

          echo "### Environment Updated! :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "**Function:** ${FUNCTION_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "**MONGO_URL:** Updated successfully" >> $GITHUB_STEP_SUMMARY
